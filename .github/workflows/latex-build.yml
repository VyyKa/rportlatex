name: LaTeX PDF Build

# Kích hoạt: push, pull_request và chạy thủ công (workflow_dispatch)
on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Kiểm tra cơ bản (sanity checks) ---------------------------------
      # Đổi biến ROOT_TEX nếu file gốc (entry) không phải là main.tex
      - name: Determine root file
        id: root
        run: |
          ROOT_TEX=${ROOT_TEX:-main.tex}
          echo "root=${ROOT_TEX}" >> "$GITHUB_OUTPUT"

      - name: Kiểm tra cơ bản (tồn tại file gốc .tex và tài nguyên)
        run: |
          set -euo pipefail
          root="${{ steps.root.outputs.root }}"
          test -f "$root" || { echo "ERROR: root file '$root' not found"; exit 1; }
          # Kiểm tra tuỳ chọn tài nguyên — chỉnh theo nhu cầu dự án
          [ -f figures/fpt-logo.png ] || echo "NOTE: figures/fpt-logo.png missing (skipping)"
          [ -f refs/references.bib ] || echo "NOTE: refs/references.bib missing (skipping)"

      # --- Biên dịch -------------------------------------------------------
      # Dùng action LaTeX được duy trì, đã kèm TeX Live.
      # Để đổi file gốc, đặt biến môi trường ROOT_TEX hoặc đổi root_file bên dưới.
      # Dự án có sẵn latexmkrc; yêu cầu latexmk dùng XeLaTeX.
      - name: Compile PDF with latexmk (XeLaTeX)
        uses: xu-cheng/latex-action@v2
        with:
          root_file: ${{ steps.root.outputs.root }}
          latexmk_use_xelatex: true
          # Thất bại job ngay khi có lỗi TeX
          args: -pdf -file-line-error -halt-on-error -interaction=nonstopmode

      # --- Artifacts -------------------------------------------------------
      # Tải artifact: sau khi job hoàn tất, mở trang run
      # và bấm vào mục "Artifacts" để tải các PDF đã tạo.
      - name: Upload PDFs
        uses: actions/upload-artifact@v4
        with:
          name: pdf-artifacts
          path: |
            ./*.pdf
            **/*.pdf
          if-no-files-found: error

      # Ghi chú cho người bảo trì:
      # - Đổi entry bằng cách đặt biến ROOT_TEX hoặc sửa bước
      #   "Determine root file" và/hoặc tham số root_file ở trên.
      # - Nếu cần gói hệ thống/font, dùng các input extra_system_packages/extra_fonts
      #   của xu-cheng/latex-action@v2.
      # - Workflow sẽ fail tự động khi biên dịch thất bại.
 